<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Community AI Agents Catalog</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 1100px; }
    h1 { margin: 0 0 8px; }
    .muted { color: #555; }
    .bar { display: flex; gap: 10px; flex-wrap: wrap; margin: 16px 0 14px; }
    input, select { padding: 10px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #ddd; }
    .pill.low { background: #f2fff5; }
    .pill.medium { background: #fffaf0; }
    .pill.high { background: #fff2f2; }
    a { color: #0b66c3; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .footer { margin-top: 18px; font-size: 12px; color: #666; }
    .error { color: #b00020; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Community AI Agents Catalog</h1>
  <div class="muted" id="meta">Loading catalog...</div>

  <div class="bar">
    <input id="q" placeholder="Search agents (name, description, tags)..." size="40" />
    <select id="category">
      <option value="">All categories</option>
    </select>
    <select id="risk">
      <option value="">All risk levels</option>
      <option value="low">low</option>
      <option value="medium">medium</option>
      <option value="high">high</option>
    </select>
  </div>

  <div id="error" class="error"></div>
  <div id="grid" class="grid"></div>

  <div class="footer">
    Source: <a id="repoLink" href="#" target="_blank" rel="noreferrer">GitHub repository</a>
  </div>

<script>
  const state = { agents: [], filtered: [] };

  // Update this if your repo name or org changes
  const ORG = "AIArchitectsOpenOrganization";
  const REPO = "Community-AI-Agents";
  const REPO_URL = `https://github.com/${ORG}/${REPO}`;
  document.getElementById("repoLink").href = REPO_URL;

  function normalize(s) {
    return (s || "").toString().toLowerCase();
  }

  function uniqueSorted(arr) {
    return [...new Set(arr)].filter(Boolean).sort((a,b) => a.localeCompare(b));
  }

  function buildCard(a) {
    const agentUrl = `${REPO_URL}/tree/main/agents/${a.slug}`;
    const tags = (a.tags || []).slice(0, 8);

    const pillRisk = `<span class="pill ${a.risk_level}">risk: ${a.risk_level}</span>`;
    const pillCat  = `<span class="pill">category: ${a.category}</span>`;
    const pillVer  = `<span class="pill">v${a.version}</span>`;

    const tagHtml = tags.map(t => `<span class="pill">${t}</span>`).join("");

    return `
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div style="font-weight:700; font-size:16px;">
            <a href="${agentUrl}" target="_blank" rel="noreferrer">${a.name}</a>
          </div>
        </div>
        <div class="muted" style="margin-top:6px;">${a.description || ""}</div>
        <div class="row">
          ${pillCat}
          ${pillRisk}
          ${pillVer}
        </div>
        <div class="row" style="margin-top:10px;">
          ${tagHtml}
        </div>
        <div class="muted" style="margin-top:10px; font-size:12px;">
          slug: <code>${a.slug}</code> â€¢ owner: ${a.owner || "community"}
        </div>
      </div>
    `;
  }

  function render() {
    const grid = document.getElementById("grid");
    grid.innerHTML = state.filtered.map(buildCard).join("");
    document.getElementById("meta").textContent =
      `Showing ${state.filtered.length} of ${state.agents.length} agents`;
  }

  function applyFilters() {
    const q = normalize(document.getElementById("q").value);
    const cat = document.getElementById("category").value;
    const risk = document.getElementById("risk").value;

    state.filtered = state.agents.filter(a => {
      if (cat && a.category !== cat) return false;
      if (risk && a.risk_level !== risk) return false;

      if (!q) return true;
      const hay = [
        a.name, a.slug, a.description,
        ...(a.tags || []),
        ...(a.tools || [])
      ].map(normalize).join(" ");
      return hay.includes(q);
    });

    render();
  }

  async function loadCatalog() {
    const error = document.getElementById("error");
    error.textContent = "";

    try {
      // catalog/index.json is generated by Step 7 script
      const res = await fetch("../catalog/index.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load catalog/index.json (${res.status})`);
      const data = await res.json();

      state.agents = (data.agents || []).slice().sort((a,b) => a.name.localeCompare(b.name));
      state.filtered = state.agents;

      const categories = uniqueSorted(state.agents.map(a => a.category));
      const catSel = document.getElementById("category");
      categories.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        catSel.appendChild(opt);
      });

      render();

      document.getElementById("q").addEventListener("input", applyFilters);
      document.getElementById("category").addEventListener("change", applyFilters);
      document.getElementById("risk").addEventListener("change", applyFilters);

    } catch (e) {
      error.textContent = "Could not load the catalog. Make sure catalog/index.json exists and is committed.";
      console.error(e);
      document.getElementById("meta").textContent = "Catalog load failed";
    }
  }

  loadCatalog();
</script>
</body>
</html>
